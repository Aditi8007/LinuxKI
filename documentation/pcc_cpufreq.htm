<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Courier;
	panose-1:2 7 4 9 2 2 5 2 4 4;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:0in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:#954F72;
	text-decoration:underline;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:.5in .5in .5in .5in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-GB link="#0563C1" vlink="#954F72">

<div class=WordSection1>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-align:
justify;vertical-align:top'><b><i><span lang=EN-US style='font-size:12.0pt;
font-family:"Arial",sans-serif;color:black'>LinuxKI Warning</span></i></b></p>

<p class=MsoNormal align=center style='margin-bottom:0in;margin-bottom:.0001pt;
text-align:center;line-height:11.25pt;vertical-align:top'><b><span lang=EN-US
style='font-size:10.0pt;font-family:"Arial",sans-serif;color:black'>&nbsp;</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><b><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>&#8203;&#8203;&#8203;&#8203;Excessive
CPU time in pcc_cpufreq driver</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>11/30/2018</span></p>

<p class=MsoNormal align=center style='margin-bottom:0in;margin-bottom:.0001pt;
text-align:center;line-height:11.25pt;vertical-align:top'><span lang=EN-US
style='font-size:10.0pt;font-family:"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><b><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>Problem</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>Customer noticed higher than expected System
CPU time after implementing a new DL380 Gen10 server using Oracle UEK kernel (4.1.12-124.16.4.el6uek.x86_64).  
The 2-socket server had 36 CPU cores with 72 threads (hyperthreading
enabled).   </span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><b><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>Investigation</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>LinuxKI data was taken for analysis.&nbsp;
&nbsp;For example:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:9.0pt;font-family:
Courier;color:black'>$ cd /dev/mem&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:9.0pt;font-family:
Courier;color:black'>$ runki&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>The Kparse Report (kp.*.html) showed the
following:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width="100%"
 style='width:100.0%;background:#FFD1A4'>
 <tr>
  <td style='padding:1.5pt 2.25pt 1.5pt 2.25pt'>
  <p class=MsoNormal style='line-height:normal'><b><span style='font-family:
  "Courier New"'>1.1.2 Global CPU Usage by LDOM</span></b></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><u><span style='font-size:9.0pt;font-family:"Courier New";color:blue'>[Prev
  Subsection][Next Subsection]---[Prev Section][Next Section][Table of
  Contents]</span></u></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><b><span style='font-size:9.0pt;font-family:"Courier New";color:black'>node 
ncpu     Total Busy          sys          usr         idle  hardirq_sys
hardirq_user hardirq idle  softirq_sys softirq_user softirq_idle</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>  
0 [ 36] :       61.75%       <span style='background:yellow'>22.75%</span>      
33.51%       35.33%        0.12%        0.19%        0.16%        2.76%       
2.42%        2.75%</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>  
1 [ 36] :       49.43%       <span style='background:yellow'>18.78%</span>      
30.06%       50.28%        0.01%        0.01%        0.03%        0.42%       
0.15%        0.26%</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><b><span style='font-size:9.0pt;font-family:"Courier New";color:black'>Total             
55.59%       <span style='background:yellow'>20.77%</span>       31.78%      
42.81%        0.07%        0.10%        0.10%        1.59%        1.29%       
1.51%</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><u><span style='font-size:9.0pt;font-family:"Courier New";color:blue'><a
href="http://gse-rose-st068.us.hpecorp.net/work/mcr/cerner/flhofldb11/0927_0104/kirunq.0927_0104.csv"
target="csv file"><span style='color:blue'>[CSV]</span></a></span></u></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>The kernel profiling data showed the
pcc_cpufreq_target() and acpi_hw_write_port() functions as top functions taking
System CPU time:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width="100%"
 style='width:100.0%;background:#FFD1A4'>
 <tr>
  <td style='padding:1.5pt 2.25pt 1.5pt 2.25pt'>
  <p class=MsoNormal style='line-height:normal'><b><span style='font-family:
  "Courier New"'>1.4.3 Report of non-idle kernel functions at each clock tick</span></b></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><u><span style='font-size:9.0pt;font-family:"Courier New";color:blue'>[Prev
  Subsection][Next Subsection]---[Prev Section][Next Section][Table of
  Contents]</span></u></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><b><span style='font-size:9.0pt;font-family:"Courier New";color:black'>  
Count     Pct  Function </span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black;
background:#EEEEEE'>   51609  50.15%  USER   0xffffffffffffffff</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>   
7021   6.82%  INTR   __schedule</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black;
background:#EEEEEE'>    5931   5.76%  SYS    <span style='background:yellow'>pcc_cpufreq_target</span></span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>   
1621   1.58%  SYS    <span style='background:yellow'>acpi_hw_write_port</span></span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black;
background:#EEEEEE'>    1189   1.16%  SYS    syscall_trace_leave</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>    
958   0.93%  SYS    syscall_trace_enter_phase2</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black;
background:#EEEEEE'>     744   0.72%  INTR   rds_recv_local.isra.7</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>    
696   0.68%  INTR   irq_exit</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black;
background:#EEEEEE'>     518   0.50%  SYS    tracesys_phase2</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>The stack traces will also confirm the same:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width="100%"
 style='width:100.0%;background:#FFD1A4'>
 <tr>
  <td style='padding:1.5pt 2.25pt 1.5pt 2.25pt'>
  <p class=MsoNormal style='line-height:normal'><b><span style='font-family:
  "Courier New"'>1.4.4 Report of non-idle kernel stack traces at each clock
  tick</span></b></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><u><span style='font-size:9.0pt;font-family:"Courier New";color:blue'>[Prev
  Subsection][Next Subsection]---[Prev Section][Next Section][Table of
  Contents]</span></u></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><b><span style='font-size:9.0pt;font-family:"Courier New"'>   Count    
Pct  Stack trace</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    5353  
5.20%  <span style='background:yellow'>pcc_cpufreq_target</span> 
__cpufreq_driver_target  od_check_cpu  dbs_check_cpu  od_dbs_timer 
process_one_work  worker_thread  kthread  ret_from_fork  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    1572  
1.53%  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    1488  
1.45%  <span style='background:yellow'>acpi_hw_write_port</span>  acpi_write  <span
style='background:yellow'>pcc_cpufreq_target</span>  __cpufreq_driver_target 
od_check_cpu  dbs_check_cpu  od_dbs_timer  process_one_work  worker_thread 
kthread  ret_from_fork  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    1460  
1.42%  __schedule   schedule_hrtimeout_range_clock.part.26  schedule_hrtimeout_range_clock 
schedule_hrtimeout_range  poll_schedule_timeout  do_sys_poll  sys_poll 
tracesys_phase2  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    1347  
1.31%  __schedule   schedule_user  retint_careful  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>    1189  
1.16%  syscall_trace_leave  int_very_careful  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     958  
0.93%  syscall_trace_enter_phase2  tracesys_phase2  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     820  
0.80%  __schedule   worker_thread  kthread  ret_from_fork  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     586  
0.57%  __schedule  schedule  schedule_timeout  sk_wait_data  tcp_recvmsg 
inet_recvmsg  sock_recvmsg  sock_read_iter  __vfs_read  vfs_read  sys_read 
tracesys_phase2  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     578  
0.56%  <span style='background:yellow'>pcc_cpufreq_target</span> 
__cpufreq_driver_target  dbs_freq_increase  od_check_cpu  dbs_check_cpu 
od_dbs_timer  process_one_work  worker_thread  kthread  ret_from_fork  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     518  
0.50%  tracesys_phase2  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New"'>     497  
0.48%  __schedule  schedule  schedule_user  int_careful  unknown</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>Source code analysis of the pcc_cpufreq driver
shows that there is a single system-wide pcc_lock spinlock to control access
for the ACPI writes, and with multiple cores trying to adjust the CPU
frequencies, the spinlock contention can increase.</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>static int pcc_cpufreq_target(struct cpufreq_policy
*policy,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>                           unsigned int target_freq,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>                           unsigned int relation)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>{</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       struct pcc_cpu *pcc_cpu_data;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       struct cpufreq_freqs freqs;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       u16 status;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       u32 input_buffer;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       int cpu;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       cpu = policy-&gt;cpu;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       pcc_cpu_data = per_cpu_ptr(pcc_cpu_info,
cpu);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       pr_debug(&quot;target: CPU %d should go to
target freq: %d &quot;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>              &quot;(virtual) input_offset is
0x%p\n&quot;,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>              cpu, target_freq,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>              (pcch_virt_addr +
pcc_cpu_data-&gt;input_offset));</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       freqs.old = policy-&gt;cur;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       freqs.new = target_freq;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       cpufreq_freq_transition_begin(policy,
&amp;freqs);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       <span style='background:yellow'>spin_lock(&amp;pcc_lock);</span></span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       input_buffer = 0x1 | (((target_freq * 100)</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>                            /
(ioread32(&amp;pcch_hdr-&gt;nominal) * 1000)) &lt;&lt; 8);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       iowrite32(input_buffer,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>                     (pcch_virt_addr +
pcc_cpu_data-&gt;input_offset));</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       iowrite16(CMD_SET_FREQ,
&amp;pcch_hdr-&gt;command);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       pcc_cmd();</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       /* Clear the input buffer - we are done with
the current command */</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       memset_io((pcch_virt_addr +
pcc_cpu_data-&gt;input_offset), 0, BUF_SZ);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       status = ioread16(&amp;pcch_hdr-&gt;status);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       iowrite16(0, &amp;pcch_hdr-&gt;status);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       cpufreq_freq_transition_end(policy,
&amp;freqs, status != CMD_COMPLETE);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       <span style='background:yellow'>spin_unlock(&amp;pcc_lock);</span></span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       if (status != CMD_COMPLETE) {</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>              pr_debug(&quot;target: FAILED for cpu
%d, with status: 0x%x\n&quot;,</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>                     cpu, status);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>              return -EINVAL;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       }</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       pr_debug(&quot;target: was SUCCESSFUL for cpu
%d\n&quot;, cpu);</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>       return 0;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:#E7E6E6'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>}</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>Another side effect of the of the pcc_cpufreq
driver is that it can drop the CPU Frequency to run at lower speeds quickly,
but takes too long to increase the CPU frequency as CPUs become busy, thus
artificially keeping the CPU frequency low even during busy periods.    The Kparse
Report will show the high and low frequencies of each CPU core in the Power
Savings Report section:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<table class=MsoNormalTable border=0 cellspacing=0 cellpadding=0 width="100%"
 style='width:100.0%;background:#FFD1A4'>
 <tr>
  <td style='padding:1.5pt 2.25pt 1.5pt 2.25pt'>
  <p class=MsoNormal style='line-height:normal'><b><span style='font-family:
  "Courier New"'>1.1.3 Power Savings Report</span></b></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><u><span style='font-size:9.0pt;font-family:"Courier New";color:blue'>[Prev
  Subsection][Next Subsection]---[Prev Section][Next Section][Table of
  Contents]</span></u></p>
  </td>
 </tr>
</table>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><b><span style='font-size:9.0pt;font-family:"Courier New";color:black'>cpu
node    Events   Cstate1   Cstate2   Cstate3   Cstate4  freq_changes   
freq_hi   freq_low</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>0  
[ 0]         0    27.46%</span><span style='font-size:9.0pt;font-family:"Courier New";
color:#CC0000'>    51.16%    20.66%     0.72%         1480    2300000   
1629000</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>1  
[ 0]         0    26.98%</span><span style='font-size:9.0pt;font-family:"Courier New";
color:#CC0000'>    40.01%    32.40%     0.61%         1614    2300000   
1332000</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>2  
[ 0]         0     1.01%</span><span style='font-size:9.0pt;font-family:"Courier New";
color:#CC0000'>     8.47%    85.66%     4.86%         1797    2300000   
1299000</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:black'>3  
[ 0]         0     1.65%</span><span style='font-size:9.0pt;font-family:"Courier New";
color:#CC0000'>    10.64%    82.21%     5.51%         1470    2300000   
1211000</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:9.0pt;font-family:
"Courier New";color:black'>...</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal'><span style='font-size:9.0pt;font-family:"Courier New";color:#CC0000'>Warning:
System enabled for power savings </span><u><span style='font-size:9.0pt;
font-family:"Courier New";color:blue'>[INFO][Next]</span></u></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-size:10.0pt;font-family:
"Arial",sans-serif;color:black'>Reducing the CPU frequency can help promote Turboboost
in busy CPU cores, however, the pcc_cpufreq driver isnt efficient in
increasing the CPU frequency when the CPU core becomes busy.</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
normal;background:white'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><b><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>Solution</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><b><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></b></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>The best solution is to disable the
pcc_cpufreq driver.   This can be done in a variety of ways:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoListParagraphCxSpFirst style='margin-bottom:0in;margin-bottom:.0001pt;
text-indent:-.25in;line-height:11.25pt;vertical-align:top'><span lang=EN-US
style='font-size:10.0pt;font-family:Symbol;color:black'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US style='font-size:10.0pt;font-family:"Arial",sans-serif;
color:black'>Change the CPU governor from ondemand to performance</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-bottom:0in;margin-bottom:
.0001pt;text-indent:-.25in;line-height:11.25pt;vertical-align:top'><span
lang=EN-US style='font-size:10.0pt;font-family:Symbol;color:black'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US style='font-size:10.0pt;font-family:"Arial",sans-serif;
color:black'>Use tuned-adm to change profile from throughput-performance to
latency-performance (or similar)</span></p>

<p class=MsoListParagraphCxSpMiddle style='margin-bottom:0in;margin-bottom:
.0001pt;text-indent:-.25in;line-height:11.25pt;vertical-align:top'><span
lang=EN-US style='font-size:10.0pt;font-family:Symbol;color:black'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US style='font-size:10.0pt;font-family:"Arial",sans-serif;
color:black'>Disable Collaborative Power Control in the system BIOS</span></p>

<p class=MsoListParagraphCxSpLast style='margin-bottom:0in;margin-bottom:.0001pt;
text-indent:-.25in;line-height:11.25pt;vertical-align:top'><span lang=EN-US
style='font-size:10.0pt;font-family:Symbol;color:black'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><span lang=EN-US style='font-size:10.0pt;font-family:"Arial",sans-serif;
color:black'>blacklist the pcc_cpufreq driver so it does not load at boot</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>Keep in mind that some of the
solutions above may also limit c-states to 1, which would increase power
usage.   </span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>For more information on Power
savings and Performance, refer to the following article:</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif;color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span class=MsoHyperlink><span lang=EN-US
style='font-size:10.0pt;font-family:"Arial",sans-serif'><a
href="http://htmlpreview.github.io/?https://github.com/HewlettPackard/LinuxKI/blob/master/documentation/power_vs_perf.htm">http://htmlpreview.github.io/?https://github.com/HewlettPackard/LinuxKI/blob/master/documentation/power_vs_perf.htm</a></span></span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-family:"Arial",sans-serif;
color:black'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif'>&nbsp;</span></p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
11.25pt;vertical-align:top'><span lang=EN-US style='font-size:10.0pt;
font-family:"Arial",sans-serif'>&nbsp;</span></p>

</div>

</body>

</html>
